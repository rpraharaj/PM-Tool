<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Milestone Manager</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Bootswatch theme for a modern look -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.2/flatly/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Google Font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />

  <!-- Bootstrap Icons -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css"
    rel="stylesheet"
  />

  <!-- vis.js Timeline CSS -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/7.7.0/vis-timeline-graph2d.min.css"
    rel="stylesheet"
  />

  <!-- Frappe Gantt CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.0/dist/frappe-gantt.css"
    rel="stylesheet"
  />

  <!-- FullCalendar CSS -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: 'Inter', 'Segoe UI', Tahoma, sans-serif;
      background-color: #f8f9fa;
    }

    /* Top Navbar */
    .navbar {
      border-bottom: 1px solid #dee2e6;
    }

    .navbar-brand {
      font-weight: 600;
    }

    #selected-project-label {
      font-weight: 500;
    }

    /* Left Sidebar */
    #sidebar {
      border-right: 1px solid #dee2e6;
      min-height: 100vh;
      background-color: #fff;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    #sidebar .btn {
      margin-bottom: 1rem;
    }

    #project-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    #project-list .nav-link {
      color: #333;
      border-radius: 4px;
      padding: 6px 10px;
      margin-bottom: 4px;
      transition: background 0.3s, color 0.3s;
    }

    #project-list .nav-link:hover,
    #project-list .nav-link.active {
      background-color: #e9ecef;
      color: #000;
    }

    /* Main Content */
    #main-content {
      padding: 1rem;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0,0,0,0.05);
    }

    /* "No project selected" section */
    #no-project-selected {
      margin-top: 50px;
    }

    /* Views (hidden by default, shown via JS) */
    #timeline-view,
    #gantt-view,
    #kanban-view,
    #calendar-view,
    #import-export-view {
      display: none;
      background-color: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 1rem;
    }

    /* Additional styling for timeline/gantt containers */
    #timeline-container {
      overflow-x: auto;
      width: 100%;
      min-width: 800px;
    }

    #gantt-container,
    #calendar-container {
      min-height: 400px;
    }

    /* Kanban container */
    #kanban-view {
      min-height: 400px;
    }

    /* Toast for notifications */
    .toast-container {
      z-index: 1055;
    }
  </style>
</head>
<body>
  <!-- Top Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Milestone Manager</a>
      <!-- This label shows the current project or "Select a project" -->
      <div class="mx-auto" id="selected-project-label">Select a project</div>
      <div class="navbar-nav ms-auto">
        <!-- These links toggle the different views -->
        <a class="nav-link" href="#" id="timeline-link">Timeline</a>
        <a class="nav-link" href="#" id="gantt-link">Gantt</a>
        <a class="nav-link" href="#" id="kanban-link">Kanban</a>
        <a class="nav-link" href="#" id="calendar-link">Calendar</a>
        <a class="nav-link" href="#" id="export-link">Export</a>
        <a class="nav-link" href="#" id="import-link">Import</a>
      </div>
    </div>
  </nav>

  <!-- Main Layout: Sidebar + Content -->
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar (Projects) -->
      <div class="col-md-3 col-lg-2" id="sidebar">
        <div class="p-3">
          <button class="btn btn-primary w-100" id="add-project-btn">
            + New Project
          </button>
          <ul id="project-list"></ul>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="col-md-9 col-lg-10" id="main-content">
        <!-- Section shown if no project is selected -->
        <div id="no-project-selected" class="text-center">
          <h3>No project selected</h3>
          <p>Create a new project or select an existing one to get started.</p>
          <button class="btn btn-primary" id="create-project-btn-2">
            + New Project
          </button>
        </div>

        <!-- Once a project is selected, show the "Add Task" button -->
        <div class="my-3" id="project-actions" style="display:none;">
          <button class="btn btn-success" id="add-task-btn">
            <i class="bi bi-plus-square"></i> Add Task
          </button>
        </div>

        <!-- Timeline View -->
        <div id="timeline-view">
          <div class="mb-3">
            <label class="fw-bold">Timeline Range:</label>
            <div class="d-flex flex-wrap gap-2">
              <input
                type="date"
                id="timeline-start-date"
                class="form-control"
                style="max-width:200px;"
              />
              <input
                type="date"
                id="timeline-end-date"
                class="form-control"
                style="max-width:200px;"
              />
              <button class="btn btn-primary" id="set-timeline-range-btn">
                Set Range
              </button>
              <button class="btn btn-secondary" id="reset-timeline-range-btn">
                Reset
              </button>
            </div>
          </div>
          <div id="timeline-container"></div>
        </div>

        <!-- Gantt View -->
        <div id="gantt-view">
          <div class="mb-3">
            <label for="gantt-view-mode" class="fw-bold">Gantt View Mode:</label>
            <div class="d-flex flex-wrap gap-2 align-items-center">
              <select
                id="gantt-view-mode"
                class="form-select"
                style="max-width:200px;"
              >
                <option value="Day">Daily</option>
                <option value="Week">Weekly</option>
                <option value="Month">Monthly</option>
                <option value="Quarter">Quarterly</option>
                <option value="Year">Yearly</option>
              </select>
              <button class="btn btn-outline-primary btn-sm" id="gantt-zoom-in-btn">
                Zoom In
              </button>
              <button
                class="btn btn-outline-primary btn-sm"
                id="gantt-zoom-out-btn"
              >
                Zoom Out
              </button>
            </div>
          </div>
          <div id="gantt-container"></div>
        </div>

        <!-- Kanban View -->
        <div id="kanban-view"></div>

        <!-- Calendar View -->
        <div id="calendar-view">
          <div id="calendar-container"></div>
        </div>

        <!-- Import/Export View -->
        <div id="import-export-view">
          <h4>Import Data</h4>
          <input
            type="file"
            id="import-file-input"
            accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
          />
          <button class="btn btn-primary mt-2" id="import-btn">
            <i class="bi bi-upload"></i> Import
          </button>
          <h4 class="mt-4">Export Data</h4>
          <button class="btn btn-secondary" id="export-csv-btn">
            <i class="bi bi-download"></i> Export CSV
          </button>
          <button class="btn btn-secondary" id="export-pdf-btn">
            <i class="bi bi-file-earmark-pdf"></i> Export PDF
          </button>
          <button class="btn btn-secondary mt-2" id="export-json-btn">
            <i class="bi bi-filetype-json"></i> Export JSON
          </button>
          <h4 class="mt-4">Import JSON</h4>
          <input
            type="file"
            id="import-json-input"
            accept=".json,application/json"
          />
          <button class="btn btn-primary mt-2" id="import-json-btn">
            <i class="bi bi-upload"></i> Import JSON
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Creation Modal -->
  <div
    class="modal fade"
    id="projectModal"
    tabindex="-1"
    aria-labelledby="projectModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <form class="modal-content" id="project-form">
        <div class="modal-header">
          <h5 class="modal-title" id="projectModalLabel">Create New Project</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="project-name" class="form-label">Project Name *</label>
            <input type="text" class="form-control" id="project-name" required />
          </div>
          <div class="mb-3">
            <label for="project-description" class="form-label">Description</label>
            <textarea class="form-control" id="project-description"></textarea>
          </div>
          <div class="mb-3">
            <label for="project-team" class="form-label"
              >Team Members (comma separated)</label
            >
            <input type="text" class="form-control" id="project-team" />
          </div>
          <div class="mb-3">
            <label for="project-start" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="project-start" />
          </div>
          <div class="mb-3">
            <label for="project-end" class="form-label">End Date</label>
            <input type="date" class="form-control" id="project-end" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Project</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Task Modal -->
  <div
    class="modal fade"
    id="taskModal"
    tabindex="-1"
    aria-labelledby="taskModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <form class="modal-content" id="task-form">
        <div class="modal-header">
          <h5 class="modal-title" id="taskModalLabel">Add/Edit Task</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="task-title" class="form-label">Title *</label>
            <input type="text" class="form-control" id="task-title" required />
          </div>
          <div class="mb-3">
            <label for="task-description" class="form-label">Description</label>
            <textarea class="form-control" id="task-description"></textarea>
          </div>
          <div class="mb-3">
            <label for="task-start" class="form-label">Start Date *</label>
            <input type="date" class="form-control" id="task-start" required />
          </div>
          <div class="mb-3">
            <label for="task-end" class="form-label">End Date *</label>
            <input type="date" class="form-control" id="task-end" required />
          </div>
          <div class="mb-3">
            <label for="task-status" class="form-label">Status</label>
            <select class="form-select" id="task-status">
              <option>Not Started</option>
              <option>In Progress</option>
              <option>Completed</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="task-priority" class="form-label">Priority/Color</label>
            <input
              type="color"
              class="form-control form-control-color"
              id="task-priority"
              value="#28a745"
              title="Choose color"
            />
          </div>
          <input type="hidden" id="task-id" />
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Save Task</button>
          <button
            type="button"
            class="btn btn-danger"
            id="delete-task-btn"
            style="display:none;"
          >
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Project list item template with action buttons -->
  <template id="project-list-item-template">
    <li class="nav-item d-flex align-items-center">
      <a href="#" class="nav-link flex-grow-1"></a>
      <div class="btn-group btn-group-sm ms-2">
        <button class="btn btn-outline-secondary edit-project-btn" title="Edit Project">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="btn btn-outline-danger delete-project-btn" title="Delete Project">
          <i class="bi bi-trash"></i>
        </button>
      </div>
    </li>
  </template>

  <!-- Toast for notifications -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div
      id="toast"
      class="toast"
      role="alert"
      aria-live="assertive"
      aria-atomic="true"
    >
      <div class="toast-header">
        <strong class="me-auto" id="toast-title">Notification</strong>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="toast"
          aria-label="Close"
        ></button>
      </div>
      <div class="toast-body" id="toast-message"></div>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"
  ></script>
  <!-- vis.js Timeline -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/vis-timeline/7.7.0/vis-timeline-graph2d.min.js"
  ></script>
  <!-- Frappe Gantt -->
  <script
    src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.0/dist/frappe-gantt.min.js"
  ></script>
  <!-- FullCalendar -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.8/index.global.min.js"
  ></script>
  <!-- SheetJS -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
  ></script>
  <!-- jsPDF -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
  ></script>
  <!-- SortableJS for Kanban -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"
  ></script>

  <!-- Main App Script -->
  <script>
    // Global data and instance variables
    let projects = [];
    let activeProjectId = null;

    // Load data from Local Storage
    function loadData() {
      const saved = localStorage.getItem('itpm_projects');
      if (saved) {
        projects = JSON.parse(saved);
        projects.forEach(project => {
          if (project.milestones) delete project.milestones; // remove any old property
          if (!project.tasks) project.tasks = [];
        });
      } else {
        projects = [];
      }
    }

    // Save data to Local Storage
    function saveData() {
      localStorage.setItem('itpm_projects', JSON.stringify(projects));
    }

    // Generate unique ID
    function generateId() {
      return 'id-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    }

    // Show notification toast
    function showToast(title, message, duration = 3000) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-title').textContent = title;
      document.getElementById('toast-message').textContent = message;
      const bsToast = new bootstrap.Toast(toast, { delay: duration });
      bsToast.show();
    }

    // Render project list in sidebar
    function renderProjectList() {
      const list = document.getElementById('project-list');
      list.innerHTML = '';
      const template = document.getElementById('project-list-item-template');
      
      if (projects.length === 0) {
        // Show a simple message if no projects
        const li = document.createElement('li');
        li.className = 'nav-item text-muted px-2';
        li.textContent = 'No projects yet';
        list.appendChild(li);
        return;
      }

      projects.forEach(project => {
        const clone = template.content.cloneNode(true);
        const li = clone.querySelector('li');
        const a = clone.querySelector('a');
        
        a.textContent = project.name;
        a.className = 'nav-link' + (project.id === activeProjectId ? ' active' : '');
        a.onclick = () => {
          activeProjectId = project.id;
          saveData();
          renderProjectList();
          renderAllViews();
        };

        const editBtn = clone.querySelector('.edit-project-btn');
        editBtn.onclick = (e) => {
          e.stopPropagation();
          showProjectModal(project);
        };

        const deleteBtn = clone.querySelector('.delete-project-btn');
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          if (confirm(`Delete project "${project.name}"?`)) {
            projects = projects.filter(p => p.id !== project.id);
            if (activeProjectId === project.id) {
              activeProjectId = null;
            }
            saveData();
            renderProjectList();
            renderAllViews();
            showToast('Success', 'Project deleted successfully');
          }
        };

        list.appendChild(clone);
      });
    }

    // Show project modal for add/edit
    function showProjectModal(project = null) {
      const modal = new bootstrap.Modal(document.getElementById('projectModal'));
      const form = document.getElementById('project-form');
      form.reset();
      
      document.getElementById('projectModalLabel').textContent = project
        ? 'Edit Project'
        : 'Create New Project';
      
      if (project) {
        document.getElementById('project-name').value = project.name;
        document.getElementById('project-description').value = project.description || '';
        document.getElementById('project-team').value = project.team
          ? project.team.join(', ')
          : '';
        document.getElementById('project-start').value = project.startDate || '';
        document.getElementById('project-end').value = project.endDate || '';
        form.dataset.projectId = project.id;
      } else {
        delete form.dataset.projectId;
      }
      
      modal.show();
    }

    // Handle project form submit
    function handleProjectFormSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const name = document.getElementById('project-name').value.trim();
      if (!name) {
        alert('Project name is required.');
        return;
      }

      const projectData = {
        name,
        description: document.getElementById('project-description').value.trim(),
        team: document
          .getElementById('project-team')
          .value.trim()
          .split(',')
          .map(s => s.trim())
          .filter(Boolean),
        startDate: document.getElementById('project-start').value,
        endDate: document.getElementById('project-end').value,
        tasks: []
      };

      if (form.dataset.projectId) {
        // Edit existing project
        const project = projects.find(p => p.id === form.dataset.projectId);
        if (project) {
          Object.assign(project, projectData);
          showToast('Success', 'Project updated successfully');
        }
      } else {
        // Create new project
        projectData.id = generateId();
        projects.push(projectData);
        activeProjectId = projectData.id;
        showToast('Success', 'Project created successfully');
      }

      saveData();
      renderProjectList();
      renderAllViews();
      bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
    }

    // Reset all data
    function resetData() {
      if (confirm('Are you sure you want to clear all projects?')) {
        localStorage.removeItem('itpm_projects');
        projects = [];
        activeProjectId = null;
        renderProjectList();
        renderAllViews();
      }
    }

    // Hide or show the main content sections based on selection
    function showView(viewId) {
      const views = [
        'timeline-view',
        'gantt-view',
        'kanban-view',
        'calendar-view',
        'import-export-view'
      ];
      // Hide all
      views.forEach(v => {
        document.getElementById(v).style.display = 'none';
      });
      // Show the one we want
      document.getElementById(viewId).style.display = 'block';
    }

    // Update the top label to show the active project or "Select a project"
    function updateSelectedProjectLabel() {
      const label = document.getElementById('selected-project-label');
      const project = projects.find(p => p.id === activeProjectId);
      if (project) {
        label.textContent = project.name;
      } else {
        label.textContent = 'Select a project';
      }
    }

    // Check if a project is selected, then show/hide relevant sections
    // and render each view if needed.
    function renderAllViews() {
      updateSelectedProjectLabel();
      const project = projects.find(p => p.id === activeProjectId);

      const noProjectEl = document.getElementById('no-project-selected');
      const projectActionsEl = document.getElementById('project-actions');

      if (!project) {
        // No project selected
        noProjectEl.style.display = 'block';
        projectActionsEl.style.display = 'none';

        // Hide all possible content views
        document.getElementById('timeline-view').style.display = 'none';
        document.getElementById('gantt-view').style.display = 'none';
        document.getElementById('kanban-view').style.display = 'none';
        document.getElementById('calendar-view').style.display = 'none';
        document.getElementById('import-export-view').style.display = 'none';
      } else {
        // Project selected
        noProjectEl.style.display = 'none';
        projectActionsEl.style.display = 'block';
      }
    }

    // Timeline view
    function renderTimeline() {
      const container = document.getElementById('timeline-container');
      container.innerHTML = '<p>Select a project to view its timeline.</p>';
      const project = projects.find(p => p.id === activeProjectId);
      if (!project) return;

      const groups = new vis.DataSet(
        project.tasks.map(t => ({ id: 't_' + t.id, content: 'ðŸ—’ï¸ ' + t.title }))
      );
      const items = new vis.DataSet(
        project.tasks.map(t => ({
          id: t.id,
          content: '',
          start: t.startDate,
          end: t.endDate,
          group: 't_' + t.id,
          className: t.status.toLowerCase().replace(' ', '-')
        }))
      );
      const options = {
        editable: false,
        margin: { item: 20 },
        zoomable: true,
        stack: false
      };
      const timeline = new vis.Timeline(container, items, groups, options);

      document.getElementById('set-timeline-range-btn').onclick = () => {
        const start = document.getElementById('timeline-start-date').value;
        const end = document.getElementById('timeline-end-date').value;
        if (!start || !end) {
          alert('Please select both start and end dates.');
          return;
        }
        timeline.setWindow(new Date(start), new Date(end));
      };

      document.getElementById('reset-timeline-range-btn').onclick = () => {
        timeline.fit();
      };
    }

    // Gantt Chart view
    function renderGantt() {
      const container = document.getElementById('gantt-container');
      container.innerHTML = '';
      const project = projects.find(p => p.id === activeProjectId);
      if (!project) {
        container.innerHTML = '<p>Select a project to view its Gantt chart.</p>';
        return;
      }
      const tasks = project.tasks.map(t => ({
        id: t.id,
        name: 'ðŸ—’ï¸ ' + t.title,
        start: t.startDate,
        end: t.endDate,
        progress:
          t.status === 'Completed' ? 100 : t.status === 'In Progress' ? 50 : 0,
        dependencies: ''
      }));
      const viewModeSelect = document.getElementById('gantt-view-mode');
      let viewMode = 'Day';
      if (viewModeSelect) {
        const selected = viewModeSelect.value;
        viewMode = selected === 'Quarter' ? 'Month' : selected;
      }

      // Create the Gantt chart with an on_date_change callback
      new Gantt(container, tasks, {
        view_mode: viewMode,
        language: 'en',
        on_date_change: function (task, start, end) {
          const currentProject = projects.find(p => p.id === activeProjectId);
          if (currentProject) {
            const currentTask = currentProject.tasks.find(t => t.id === task.id);
            if (currentTask) {
              // Update task dates
              currentTask.startDate = start.toISOString().split('T')[0];
              currentTask.endDate = end.toISOString().split('T')[0];
              saveData();
              showToast('Success', 'Task dates updated via Gantt chart.');
              // Re-render so all views stay in sync
              renderAllViews();
            }
          }
        }
      });

      // Zoom in/out controls
      if (viewModeSelect && !viewModeSelect._listenerAdded) {
        viewModeSelect.addEventListener('change', () => {
          renderGantt();
        });
        const modes = ['Day', 'Week', 'Month', 'Year'];
        document.getElementById('gantt-zoom-in-btn').onclick = () => {
          let current = viewModeSelect.value;
          if (current === 'Quarter') current = 'Month';
          let idx = modes.indexOf(current);
          if (idx > 0) {
            viewModeSelect.value = modes[idx - 1];
            renderGantt();
          }
        };
        document.getElementById('gantt-zoom-out-btn').onclick = () => {
          let current = viewModeSelect.value;
          if (current === 'Quarter') current = 'Month';
          let idx = modes.indexOf(current);
          if (idx < modes.length - 1) {
            viewModeSelect.value = modes[idx + 1];
            renderGantt();
          }
        };
        viewModeSelect._listenerAdded = true;
      }
    }

    // Kanban view using SortableJS
    function renderKanban() {
      const kanbanContainer = document.getElementById('kanban-view');
      const project = projects.find(p => p.id === activeProjectId);
      if (!project) {
        kanbanContainer.innerHTML =
          "<div class='alert alert-info'>Select a project to view its Kanban board.</div>";
        return;
      }

      // Define statuses
      const statuses = [
        { id: 'not_started', title: 'Not Started' },
        { id: 'in_progress', title: 'In Progress' },
        { id: 'completed', title: 'Completed' }
      ];

      // Build columns
      let html = `<div class="row">`;
      statuses.forEach(status => {
        html += `<div class="col-md-4 mb-3">
                   <div class="card">
                     <div class="card-header bg-secondary text-white" data-status="${status.id}">
                       ${status.title}
                     </div>
                     <div class="card-body" id="kanban-column-${status.id}" style="min-height:300px;">`;
        const tasksForStatus = project.tasks.filter(task => {
          const s = task.status.toLowerCase().replace(/\s+/g, '_');
          return s === status.id;
        });
        tasksForStatus.forEach(task => {
          html += `<div class="card mb-2 kanban-item" data-task-id="${task.id}" style="cursor:pointer;">
                     <div class="card-body p-2" style="background-color: ${task.color};">
                       <h6 class="card-title mb-1">${task.title}</h6>
                       <p class="card-text small mb-0">${task.startDate} - ${task.endDate}</p>
                     </div>
                   </div>`;
        });
        html += `</div></div></div>`;
      });
      html += `</div>`;
      kanbanContainer.innerHTML = html;

      // Make columns sortable
      statuses.forEach(status => {
        const columnEl = document.getElementById('kanban-column-' + status.id);
        if (columnEl) {
          new Sortable(columnEl, {
            group: 'kanban',
            animation: 150,
            onAdd: function (evt) {
              const taskId = evt.item.getAttribute('data-task-id');
              const newStatus = evt.to.parentElement
                .querySelector('.card-header')
                .getAttribute('data-status');
              const task = project.tasks.find(t => t.id === taskId);
              if (task) {
                if (newStatus === 'not_started') {
                  task.status = 'Not Started';
                } else if (newStatus === 'in_progress') {
                  task.status = 'In Progress';
                } else if (newStatus === 'completed') {
                  task.status = 'Completed';
                }
                saveData();
                showToast('Success', `Task "${task.title}" moved to ${task.status}`);
              }
            }
          });
        }
      });

      // Click event to edit tasks
      const items = kanbanContainer.querySelectorAll('.kanban-item');
      items.forEach(item => {
        item.addEventListener('click', () => {
          const taskId = item.getAttribute('data-task-id');
          const task = project.tasks.find(t => t.id === taskId);
          if (task) showTaskModal(task);
        });
      });
    }

    // Calendar view using FullCalendar
    function renderCalendar() {
      const calendarContainer = document.getElementById('calendar-container');
      calendarContainer.innerHTML = '';
      const project = projects.find(p => p.id === activeProjectId);
      if (!project) {
        calendarContainer.innerHTML =
          '<p>Select a project to view its calendar.</p>';
        return;
      }

      const events = project.tasks.map(t => ({
        id: t.id,
        title: t.title,
        start: t.startDate,
        end: t.endDate
      }));

      const calendar = new FullCalendar.Calendar(calendarContainer, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        events: events
      });
      calendar.render();
    }

    // Initialize the app
    function init() {
      loadData();
      renderProjectList();
      renderAllViews();

      // Top nav links
      document.getElementById('timeline-link').onclick = () => {
        const project = projects.find(p => p.id === activeProjectId);
        if (!project) {
          showToast('Info', 'No project selected');
          return;
        }
        showView('timeline-view');
        renderTimeline();
      };

      document.getElementById('gantt-link').onclick = () => {
        const project = projects.find(p => p.id === activeProjectId);
        if (!project) {
          showToast('Info', 'No project selected');
          return;
        }
        showView('gantt-view');
        renderGantt();
      };

      document.getElementById('kanban-link').onclick = () => {
        const project = projects.find(p => p.id === activeProjectId);
        if (!project) {
          showToast('Info', 'No project selected');
          return;
        }
        showView('kanban-view');
        renderKanban();
      };

      document.getElementById('calendar-link').onclick = () => {
        const project = projects.find(p => p.id === activeProjectId);
        if (!project) {
          showToast('Info', 'No project selected');
          return;
        }
        showView('calendar-view');
        renderCalendar();
      };

      document.getElementById('export-link').onclick = () => {
        showView('import-export-view');
      };
      document.getElementById('import-link').onclick = () => {
        showView('import-export-view');
      };

      // Sidebar + "no project" buttons
      document.getElementById('add-project-btn').onclick = () => showProjectModal();
      document.getElementById('create-project-btn-2').onclick = () => showProjectModal();

      // Reset data
      document.getElementById('reset-data-btn').onclick = resetData;

      // Project form
      document.getElementById('project-form').onsubmit = handleProjectFormSubmit;

      // Add task
      document.getElementById('add-task-btn').onclick = () => {
        if (!activeProjectId) {
          showToast('Warning', 'Please select a project first');
          return;
        }
        showTaskModal();
      };

      // Export JSON
      document.getElementById('export-json-btn').onclick = () => {
        try {
          const dataStr = JSON.stringify(projects, null, 2);
          const blob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'projects.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert('Exported projects as JSON successfully.');
        } catch (err) {
          alert('Error exporting JSON: ' + err.message);
        }
      };

      // Export CSV
      document.getElementById('export-csv-btn').onclick = () => {
        try {
          let csv = 'Project,Type,Title,Description,Start Date,End Date,Status,Priority\n';
          projects.forEach(p => {
            p.tasks.forEach(t => {
              csv += `"${p.name}","Task","${t.title}","${t.description || ''}","${t.startDate}","${t.endDate}","${t.status}","${t.color || ''}"\n`;
            });
          });
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'projects.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert('Exported projects as CSV successfully.');
        } catch (err) {
          alert('Error exporting CSV: ' + err.message);
        }
      };

      // Export PDF
      document.getElementById('export-pdf-btn').onclick = () => {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          let y = 10;
          projects.forEach(p => {
            doc.setFontSize(14);
            doc.text(`Project: ${p.name}`, 10, y);
            y += 8;
            doc.setFontSize(12);
            doc.text('Tasks:', 10, y);
            y += 6;
            p.tasks.forEach(t => {
              doc.text(
                `- ${t.title} (${t.status}) ${t.startDate} to ${t.endDate}`,
                12,
                y
              );
              y += 6;
              if (y > 280) {
                doc.addPage();
                y = 10;
              }
            });
            y += 10;
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
          });
          doc.save('projects.pdf');
          alert('Exported projects as PDF successfully.');
        } catch (err) {
          alert('Error exporting PDF: ' + err.message);
        }
      };

      // Import JSON
      document.getElementById('import-json-btn').onclick = () => {
        const fileInput = document.getElementById('import-json-input');
        if (!fileInput.files.length) {
          alert('Please select a JSON file to import.');
          return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const imported = JSON.parse(e.target.result);
            if (!Array.isArray(imported)) {
              alert('Invalid JSON format: expected an array of projects.');
              return;
            }
            imported.forEach(p => {
              if (!p.id) p.id = generateId();
              if (!p.tasks) p.tasks = [];
            });
            projects = imported;
            saveData();
            renderProjectList();
            renderAllViews();
            alert('Projects imported successfully.');
          } catch (err) {
            alert('Error parsing JSON: ' + err.message);
          }
        };
        reader.onerror = function () {
          alert('Error reading file.');
        };
        reader.readAsText(file);
      };

      // Import CSV/Excel (placeholder)
      document.getElementById('import-btn').onclick = () => {
        alert('Import functionality for CSV/Excel is not implemented in this version.');
      };

      // Task form submit
      document.getElementById('task-form').onsubmit = handleTaskFormSubmit;
    }

    // Show task modal for add or edit
    function showTaskModal(task = null) {
      if (!activeProjectId) {
        showToast('Warning', 'Please select a project first');
        return;
      }

      const modal = new bootstrap.Modal(document.getElementById('taskModal'));
      const form = document.getElementById('task-form');
      form.reset();

      if (!task) {
        // Default to today's date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('task-start').value = today;
        document.getElementById('task-end').value = today;
      }

      document.getElementById('task-id').value = task ? task.id : '';
      document.getElementById('task-title').value = task ? task.title : '';
      document.getElementById('task-description').value = task ? task.description : '';
      document.getElementById('task-start').value = task ? task.startDate : '';
      document.getElementById('task-end').value = task ? task.endDate : '';
      document.getElementById('task-status').value = task ? task.status : 'Not Started';
      document.getElementById('task-priority').value = task ? (task.color || '#28a745') : '#28a745';

      const deleteBtn = document.getElementById('delete-task-btn');
      if (task) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.onclick = () => deleteTask(task.id);
      } else {
        deleteBtn.style.display = 'none';
      }

      modal.show();
    }

    // Handle task form submit
    function handleTaskFormSubmit(event) {
      event.preventDefault();

      const project = projects.find(p => p.id === activeProjectId);
      if (!project) {
        showToast('Error', 'No project selected');
        return;
      }

      const taskId = document.getElementById('task-id').value;
      const title = document.getElementById('task-title').value.trim();
      const startDate = document.getElementById('task-start').value;
      const endDate = document.getElementById('task-end').value;

      if (!title || !startDate || !endDate) {
        showToast('Error', 'Title, Start Date, and End Date are required');
        return;
      }

      const taskData = {
        id: taskId || generateId(),
        title: title,
        description: document.getElementById('task-description').value.trim(),
        startDate: startDate,
        endDate: endDate,
        status: document.getElementById('task-status').value,
        color: document.getElementById('task-priority').value
      };

      if (taskId) {
        // Update existing task
        const taskIndex = project.tasks.findIndex(t => t.id === taskId);
        if (taskIndex !== -1) {
          project.tasks[taskIndex] = taskData;
          showToast('Success', 'Task updated successfully');
        }
      } else {
        // Create new task
        project.tasks.push(taskData);
        showToast('Success', 'Task created successfully');
      }

      saveData();
      renderAllViews();
      bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
    }

    // Delete task
    function deleteTask(id) {
      const project = projects.find(p => p.id === activeProjectId);
      if (!project) return;
      if (!confirm('Delete this task?')) return;
      project.tasks = project.tasks.filter(t => t.id !== id);
      saveData();
      renderAllViews();
      bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
    }

    window.onload = init;
  </script>
</body>
</html>
